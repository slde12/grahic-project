<!DOCTYPE html>

<html>

<head>
    <title>Transformations</title>
    <script  src="https://threejs.org/build/three.js"></script>
    <script  src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
    <script src='https://threejs.org/examples/js/libs/dat.gui.min.js'></script>
    <script type="text/javascript">
    "use strict";
    function mainFunction() {
      "use strict";
      let renderer = new THREE.WebGLRenderer( { antialias: true } );//let renderer = new THREE.WebGLRenderer();
      renderer.setSize( window.innerWidth, window.innerHeight );
      renderer.setPixelRatio( window.devicePixelRatio );

      renderer.setClearColor (0x888888, 1);
      renderer.shadowMapEnabled = true;

      document.body.appendChild( renderer.domElement );

      let scene = new THREE.Scene();
      scene.add(new THREE.AxisHelper(10));

      let aspect = window.innerWidth / window.innerHeight;


      let camera = new THREE.PerspectiveCamera( 45, aspect, 1, 1000 );
      camera.position.x = -30;
      camera.position.y = 40;
      camera.position.z = 30;
      
      scene.add(camera);
      let cameraControls = new THREE.OrbitControls( camera, renderer.domElement);
      cameraControls.addEventListener("change",render,false)

      var gridHelper = new THREE.GridHelper( 40, 25 , 0x0F0F0F, 0xFFFFFF);
      scene.add( gridHelper );

      // add subtle ambient lighting
      let ambientLight = new THREE.AmbientLight(0x888888, 0.25);
      scene.add(ambientLight);

      // add spotlight for the shadows
      let pointLight = new THREE.PointLight( 0xffffff, 1 );
      pointLight.position.set( 15, 30, 35 );
      scene.add(pointLight);

      let boxGeom = new THREE.BoxGeometry(5, 8, 3);
      let box = new THREE.Mesh(boxGeom, new THREE.MeshLambertMaterial({color: 0x44ff44}));
      box.add(new THREE.AxisHelper(10));
      
      scene.add(box);
      
      window.addEventListener("resize",resize, false)

      setupGUI();
      
      render();
      
      function setupGUI(){
        let controls = {
          scaleX : box.scale.x,
          scaleY : box.scale.y,
          scaleZ : box.scale.z,

          positionX : box.position.x,
          positionY : box.position.y,
          positionZ : box.position.z,

          rotationX : box.rotation.x,
          rotationY : box.rotation.y,
          rotationZ : box.rotation.z,

          shearX    : function(){},
          shearYX   : 0,
          shearZX   : 0,

          shearY    : function(){},
          shearXY   : 0,
          shearZY   : 0,

          shearZ    : function(){},
          shearXZ   : 0,
          shearYZ   : 0
        };
        let gui = new dat.GUI();

        function showMatrix(){
          let str = "";
          let aIndex = [0,4,8,12,1,5,9,13,2,6,10,14,3,7,11,15];
          box.matrix.elements.forEach(
            function(e,i,A){
              str+=(i%4==0)?(i==0?"":"\n"):"\t";
              str+=(A[aIndex[i]]<0)?"":" ";
              str+=(Math.round(A[aIndex[i]]*10)/10).toFixed(1);
            }
          );
          console.log(str);
        }
        let guiScale = gui.addFolder('scale');
        //function onScaleChange(){box.scale.set(controls.scaleX, controls.scaleY, controls.scaleZ);}
        guiScale.add(controls, 'scaleX', 0, 5).onChange(function(){box.scale.x = controls.scaleX;render();showMatrix();});
        guiScale.add(controls, 'scaleY', 0, 5).onChange(function(){box.scale.y = controls.scaleY;render();showMatrix();});
        guiScale.add(controls, 'scaleZ', 0, 5).onChange(function(){box.scale.z = controls.scaleZ;render();showMatrix();});
        guiScale.open();

        let guiPosition = gui.addFolder('position');
        let contX = guiPosition.add(controls, 'positionX', -20, 20).onChange(function () {box.position.x = controls.positionX;render();showMatrix();}).listen();
        let contY = guiPosition.add(controls, 'positionY', -20, 20).onChange(function () {box.position.y = controls.positionY;render();showMatrix();});
        let contZ = guiPosition.add(controls, 'positionZ', -20, 20).onChange(function () {box.position.z = controls.positionZ;render();showMatrix();});
        guiPosition.open();

        let guiRotation = gui.addFolder('rotation');
        guiRotation.add(controls, 'rotationX', -4, 4).onChange(function(){box.rotation.x = controls.rotationX;render();showMatrix();});
        guiRotation.add(controls, 'rotationY', -4, 4).onChange(function(){box.rotation.y = controls.rotationY;render();showMatrix();});
        guiRotation.add(controls, 'rotationZ', -4, 4).onChange(function(){box.rotation.z = controls.rotationZ;render();showMatrix();});
        guiRotation.open();

        let guiShear = gui.addFolder('shear');
        let invMatrix = new THREE.Matrix4();

        guiShear.add(controls, 'shearX')
        guiShear.add(controls, 'shearYX', -.4, .4, 0.01).onChange(function(){applyShear();render();showMatrix();});
        guiShear.add(controls, 'shearZY', -.4, .4, 0.01).onChange(function(){applyShear();render();showMatrix();});
        guiShear.add(controls, 'shearY')
        guiShear.add(controls, 'shearXY', -.4, .4, 0.01).onChange(function(){applyShear();render();showMatrix();});
        guiShear.add(controls, 'shearZY', -.4, .4, 0.01).onChange(function(){applyShear();render();showMatrix();});
        guiShear.add(controls, 'shearZ')
        guiShear.add(controls, 'shearXZ', -.4, .4, 0.01).onChange(function(){applyShear();render();showMatrix();});
        guiShear.add(controls, 'shearYZ', -.4, .4, 0.01).onChange(function(){applyShear();render();showMatrix();});
        guiShear.open();

        function applyShear(){
          var geometry = box.geometry;

          var matrix = new THREE.Matrix4();
          geometry.applyMatrix( invMatrix );

          matrix.set(
            1,   controls.shearYX,  controls.shearZX,  0,
            controls.shearXY,     1,  controls.shearZY,  0,
            controls.shearXZ,   controls.shearYZ,   1,   0,
            0,     0,   0,   1  );

          invMatrix.getInverse(matrix);

          geometry.applyMatrix( matrix );
        }
      }

      function render() {
        //requestAnimationFrame(render);
        renderer.render(scene, camera);
      }
      function resize() {
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        //render();
      }

    }
</script>
</head>
<body onload="mainFunction();">
</body>
</html>